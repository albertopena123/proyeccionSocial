import { PrismaClient, UserRole, PermissionAction, ModuleType } from '@prisma/client'
import bcrypt from 'bcryptjs'

const prisma = new PrismaClient()

async function main() {
  console.log('üå± Iniciando seed...')

  // Limpiar base de datos
  await prisma.userPermission.deleteMany()
  await prisma.permission.deleteMany()
  await prisma.auditLog.deleteMany()
  await prisma.session.deleteMany()
  await prisma.account.deleteMany()
  await prisma.userPreferences.deleteMany()
  await prisma.user.deleteMany()
  await prisma.submodule.deleteMany()
  await prisma.module.deleteMany()

  console.log('üßπ Base de datos limpia')

  // Crear usuarios de prueba
  const hashedPassword = await bcrypt.hash('password123', 10)

  const superAdmin = await prisma.user.create({
    data: {
      email: 'superadmin@unamad.edu.pe',
      personalEmail: 'superadmin@example.com',
      name: 'Super Admin',
      password: hashedPassword,
      role: UserRole.SUPER_ADMIN,
      emailVerified: new Date(),
      isActive: true,
      studentCode: '20200001',
      documentType: 'DNI',
      documentNumber: '12345678',
      dni: '12345678',
      sex: 'M',
      faculty: 'Facultad de Ingenier√≠a',
      career: 'Ingenier√≠a de Sistemas e Inform√°tica',
      careerCode: 'ISI',
      enrollmentDate: '2020-1',
      preferences: {
        create: {
          theme: 'light'
        }
      }
    }
  })

  const admin = await prisma.user.create({
    data: {
      email: 'admin@unamad.edu.pe',
      personalEmail: 'admin@example.com',
      name: 'Admin User',
      password: hashedPassword,
      role: UserRole.ADMIN,
      emailVerified: new Date(),
      isActive: true,
      studentCode: '20200002',
      documentType: 'DNI',
      documentNumber: '87654321',
      dni: '87654321',
      sex: 'F',
      faculty: 'Facultad de Ingenier√≠a',
      career: 'Ingenier√≠a de Sistemas e Inform√°tica',
      careerCode: 'ISI',
      enrollmentDate: '2020-1',
      preferences: {
        create: {
          theme: 'light'
        }
      }
    }
  })

  const moderator = await prisma.user.create({
    data: {
      email: 'moderator@unamad.edu.pe',
      personalEmail: 'moderator@example.com',
      name: 'Moderator User',
      password: hashedPassword,
      role: UserRole.MODERATOR,
      emailVerified: new Date(),
      isActive: true,
      studentCode: '20210001',
      documentType: 'CE',
      documentNumber: 'CE1122334',
      dni: '11223344',
      sex: 'M',
      faculty: 'Facultad de Educaci√≥n',
      career: 'Educaci√≥n Matem√°tica y Computaci√≥n',
      careerCode: 'EMC',
      enrollmentDate: '2021-1',
      preferences: {
        create: {
          theme: 'dark'
        }
      }
    }
  })

  const user = await prisma.user.create({
    data: {
      email: 'user@unamad.edu.pe',
      personalEmail: 'user@example.com',
      name: 'Regular User',
      password: hashedPassword,
      role: UserRole.USER,
      emailVerified: new Date(),
      isActive: true,
      studentCode: '20220001',
      documentType: 'DNI',
      documentNumber: '99887766',
      dni: '99887766',
      sex: 'F',
      faculty: 'Facultad de Ecoturismo',
      career: 'Administraci√≥n y Negocios Internacionales',
      careerCode: 'ANI',
      enrollmentDate: '2022-1',
      preferences: {
        create: {
          theme: 'system'
        }
      }
    }
  })

  console.log('‚úÖ Usuarios creados')

  // Crear m√≥dulos principales
  const dashboardModule = await prisma.module.create({
    data: {
      name: 'Dashboard',
      slug: 'dashboard',
      description: 'Panel principal con m√©tricas y estad√≠sticas',
      icon: 'LayoutDashboard',
      type: ModuleType.CORE,
      isActive: true,
      order: 1
    }
  })

  const usersModule = await prisma.module.create({
    data: {
      name: 'Gesti√≥n de Usuarios',
      slug: 'users',
      description: 'Administraci√≥n de usuarios y permisos',
      icon: 'Users',
      type: ModuleType.CORE,
      isActive: true,
      order: 2,
      submodules: {
        create: [
          {
            name: 'Lista de Usuarios',
            slug: 'users-list',
            description: 'Ver y gestionar usuarios del sistema',
            icon: 'UserCog',
            isActive: true,
            order: 1
          },
          {
            name: 'Roles y Permisos',
            slug: 'roles-permissions',
            description: 'Configurar roles y permisos de acceso',
            icon: 'Shield',
            isActive: true,
            order: 2
          },
          {
            name: 'Gesti√≥n de M√≥dulos',
            slug: 'modules-management',
            description: 'Administrar m√≥dulos y subm√≥dulos del sistema',
            icon: 'Cube',
            isActive: true,
            order: 3
          }
        ]
      }
    },
    include: {
      submodules: true
    }
  })

  const contentModule = await prisma.module.create({
    data: {
      name: 'Gesti√≥n de Contenido',
      slug: 'content',
      description: 'Administraci√≥n de contenido del sitio',
      icon: 'FileText',
      type: ModuleType.FEATURE,
      isActive: true,
      order: 3,
      submodules: {
        create: [
          {
            name: 'Art√≠culos',
            slug: 'articles',
            description: 'Gestionar art√≠culos y publicaciones',
            icon: 'Newspaper',
            isActive: true,
            order: 1
          },
          {
            name: 'Categor√≠as',
            slug: 'categories',
            description: 'Organizar contenido por categor√≠as',
            icon: 'FolderOpen',
            isActive: true,
            order: 2
          }
        ]
      }
    },
    include: {
      submodules: true
    }
  })

  // M√≥dulo de Documentos
  const documentsModule = await prisma.module.create({
    data: {
      name: 'Documentos',
      slug: 'documents',
      description: 'Gesti√≥n de documentos universitarios',
      icon: 'FileText',
      type: ModuleType.FEATURE,
      isActive: true,
      order: 4,
      submodules: {
        create: [
          {
            name: 'Constancias',
            slug: 'constancias',
            description: 'Gesti√≥n de constancias universitarias',
            icon: 'FileCheck',
            isActive: true,
            order: 1
          },
          {
            name: 'Resoluciones',
            slug: 'resoluciones',
            description: 'Gesti√≥n de resoluciones universitarias',
            icon: 'FilePlus',
            isActive: true,
            order: 2
          },
          {
            name: 'UNAMAD',
            slug: 'unamad',
            description: 'Documentos oficiales de UNAMAD',
            icon: 'Building',
            isActive: true,
            order: 3
          },
          {
            name: 'DPSEC',
            slug: 'dpsec',
            description: 'Documentos de DPSEC',
            icon: 'Shield',
            isActive: true,
            order: 4
          }
        ]
      }
    },
    include: {
      submodules: true
    }
  })

  const settingsModule = await prisma.module.create({
    data: {
      name: 'Configuraci√≥n',
      slug: 'settings',
      description: 'Configuraci√≥n del sistema',
      icon: 'Settings',
      type: ModuleType.CORE,
      isActive: true,
      order: 99,
      submodules: {
        create: [
          {
            name: 'Apariencia',
            slug: 'appearance',
            description: 'Personaliza colores, temas y dise√±o',
            icon: 'Palette',
            isActive: true,
            order: 1,
            config: {
              showThemeSelector: true,
              showColorPicker: true,
              showRadiusControl: true,
              showFontSize: true
            }
          },
          {
            name: 'Accesibilidad',
            slug: 'accessibility',
            description: 'Opciones de accesibilidad',
            icon: 'Accessibility',
            isActive: true,
            order: 2
          },
          {
            name: 'Notificaciones',
            slug: 'notifications',
            description: 'Gestiona tus notificaciones',
            icon: 'Bell',
            isActive: true,
            order: 3
          },
          {
            name: 'Cuenta',
            slug: 'account',
            description: 'Informaci√≥n y seguridad de tu cuenta',
            icon: 'User',
            isActive: true,
            order: 4
          },
          {
            name: 'Privacidad',
            slug: 'privacy',
            description: 'Configuraci√≥n de privacidad y datos',
            icon: 'Shield',
            isActive: true,
            order: 5
          }
        ]
      }
    },
    include: {
      submodules: true
    }
  })

  console.log('‚úÖ M√≥dulos creados')

  // Crear permisos simplificados
  const permissions = []

  // Permisos del Dashboard
  permissions.push({
    name: 'Acceso al Dashboard',
    code: 'dashboard.access',
    description: 'Acceso al dashboard principal',
    moduleId: dashboardModule.id,
    actions: [
      PermissionAction.READ,
      PermissionAction.EXPORT
    ]
  })

  // Permisos para subm√≥dulos de Usuarios
  for (const submodule of usersModule.submodules) {
    let permissionName = ''
    let permissionCode = ''
    let permissionDesc = ''

    switch (submodule.slug) {
      case 'users-list':
        permissionName = 'Gesti√≥n de Usuarios'
        permissionCode = 'users.access'
        permissionDesc = 'Acceso completo al m√≥dulo de gesti√≥n de usuarios'
        break
      case 'roles-permissions':
        permissionName = 'Gesti√≥n de Roles y Permisos'
        permissionCode = 'roles.access'
        permissionDesc = 'Acceso completo al m√≥dulo de roles y permisos'
        break
      case 'modules-management':
        permissionName = 'Gesti√≥n de M√≥dulos'
        permissionCode = 'modules.access'
        permissionDesc = 'Acceso completo al m√≥dulo de gesti√≥n de m√≥dulos del sistema'
        break
    }

    permissions.push({
      name: permissionName,
      code: permissionCode,
      description: permissionDesc,
      moduleId: usersModule.id,
      submoduleId: submodule.id,
      actions: [
        PermissionAction.CREATE,
        PermissionAction.READ,
        PermissionAction.UPDATE,
        PermissionAction.DELETE,
        PermissionAction.EXPORT
      ]
    })
  }

  // Permisos para subm√≥dulos de Contenido
  for (const submodule of contentModule.submodules) {
    permissions.push({
      name: `Gesti√≥n de ${submodule.name}`,
      code: `${submodule.slug}.access`,
      description: `Acceso completo al m√≥dulo de ${submodule.name.toLowerCase()}`,
      moduleId: contentModule.id,
      submoduleId: submodule.id,
      actions: [
        PermissionAction.CREATE,
        PermissionAction.READ,
        PermissionAction.UPDATE,
        PermissionAction.DELETE,
        PermissionAction.EXPORT
      ]
    })
  }

  // Permisos para subm√≥dulos de Documentos
  for (const submodule of documentsModule.submodules) {
    permissions.push({
      name: `Gesti√≥n de ${submodule.name}`,
      code: `${submodule.slug}.access`,
      description: `Acceso completo al m√≥dulo de ${submodule.name.toLowerCase()}`,
      moduleId: documentsModule.id,
      submoduleId: submodule.id,
      actions: [
        PermissionAction.CREATE,
        PermissionAction.READ,
        PermissionAction.UPDATE,
        PermissionAction.DELETE,
        PermissionAction.EXPORT
      ]
    })
  }

  // Permisos para subm√≥dulos de Configuraci√≥n
  for (const submodule of settingsModule.submodules) {
    let permissionName = ''
    let permissionCode = ''
    let permissionDesc = ''
    let actions: PermissionAction[] = []

    switch (submodule.slug) {
      case 'appearance':
        permissionName = 'Configuraci√≥n de Apariencia'
        permissionCode = 'appearance.access'
        permissionDesc = 'Personalizar temas, colores y dise√±o de la interfaz'
        actions = [
          PermissionAction.READ,
          PermissionAction.UPDATE
        ]
        break
      case 'accessibility':
        permissionName = 'Configuraci√≥n de Accesibilidad'
        permissionCode = 'accessibility.access'
        permissionDesc = 'Gestionar opciones de accesibilidad'
        actions = [
          PermissionAction.READ,
          PermissionAction.UPDATE
        ]
        break
      case 'notifications':
        permissionName = 'Configuraci√≥n de Notificaciones'
        permissionCode = 'notifications.access'
        permissionDesc = 'Gestionar preferencias de notificaciones'
        actions = [
          PermissionAction.CREATE,
          PermissionAction.READ,
          PermissionAction.UPDATE,
          PermissionAction.DELETE
        ]
        break
      case 'account':
        permissionName = 'Configuraci√≥n de Cuenta'
        permissionCode = 'account.access'
        permissionDesc = 'Gestionar informaci√≥n y seguridad de la cuenta'
        actions = [
          PermissionAction.READ,
          PermissionAction.UPDATE,
          PermissionAction.DELETE
        ]
        break
      case 'privacy':
        permissionName = 'Configuraci√≥n de Privacidad'
        permissionCode = 'privacy.access'
        permissionDesc = 'Gestionar configuraci√≥n de privacidad y datos'
        actions = [
          PermissionAction.READ,
          PermissionAction.UPDATE,
          PermissionAction.DELETE,
          PermissionAction.EXPORT
        ]
        break
    }

    permissions.push({
      name: permissionName,
      code: permissionCode,
      description: permissionDesc,
      moduleId: settingsModule.id,
      submoduleId: submodule.id,
      actions: actions
    })
  }

  // Permiso general para configuraci√≥n (compatibilidad)
  permissions.push({
    name: 'Configuraci√≥n Personal',
    code: 'settings.access',
    description: 'Acceso general a configuraci√≥n personal del usuario',
    moduleId: settingsModule.id,
    actions: [
      PermissionAction.READ,
      PermissionAction.UPDATE
    ]
  })

  // Permiso especial para administraci√≥n del sistema
  permissions.push({
    name: 'Administraci√≥n del Sistema',
    code: 'system.admin',
    description: 'Control total sobre la configuraci√≥n del sistema',
    moduleId: settingsModule.id,
    actions: [
      PermissionAction.CREATE,
      PermissionAction.READ,
      PermissionAction.UPDATE,
      PermissionAction.DELETE,
      PermissionAction.EXPORT
    ]
  })

  // Crear todos los permisos
  await prisma.permission.createMany({
    data: permissions
  })

  console.log('‚úÖ Permisos creados (sistema simplificado)')

  // ==================== CREAR FACULTADES Y DEPARTAMENTOS CORRECTOS ====================
  console.log('üèõÔ∏è Creando facultades y departamentos...')

  // FACULTAD DE ECOTURISMO
  const facultadEcoturismo = await prisma.facultad.create({
    data: {
      nombre: 'Facultad de Ecoturismo',
      codigo: 'FE',
      departamentos: {
        create: [
          { 
            nombre: 'Departamento Acad√©mico de Contabilidad y Administraci√≥n', 
            codigo: 'DACA' 
          },
          { 
            nombre: 'Departamento Acad√©mico de Ecoturismo', 
            codigo: 'DAE' 
          }
        ]
      }
    },
    include: {
      departamentos: true
    }
  })

  // FACULTAD DE INGENIER√çA
  const facultadIngenieria = await prisma.facultad.create({
    data: {
      nombre: 'Facultad de Ingenier√≠a',
      codigo: 'FI',
      departamentos: {
        create: [
          { 
            nombre: 'Departamento Acad√©mico de Ingenier√≠a Forestal y Medio Ambiente', 
            codigo: 'DAIFMA' 
          },
          { 
            nombre: 'Departamento Acad√©mico de Ingenier√≠a de Sistemas e Inform√°tica', 
            codigo: 'DAISI' 
          },
          { 
            nombre: 'Departamento Acad√©mico de Ingenier√≠a Agroindustrial', 
            codigo: 'DAIA' 
          },
          { 
            nombre: 'Departamento Acad√©mico de Medicina Veterinaria - Zootecnia', 
            codigo: 'DAMVZ' 
          },
          { 
            nombre: 'Departamento Acad√©mico de Ciencias B√°sicas', 
            codigo: 'DACB' 
          }
        ]
      }
    },
    include: {
      departamentos: true
    }
  })

  // FACULTAD DE EDUCACI√ìN
  const facultadEducacion = await prisma.facultad.create({
    data: {
      nombre: 'Facultad de Educaci√≥n',
      codigo: 'FEDU',
      departamentos: {
        create: [
          // Departamentos Acad√©micos
          { 
            nombre: 'Departamento Acad√©mico de Derecho y Ciencias Pol√≠ticas', 
            codigo: 'DADCP' 
          },
          { 
            nombre: 'Departamento Acad√©mico de Enfermer√≠a', 
            codigo: 'DAE' 
          },
          { 
            nombre: 'Departamento Acad√©mico de Educaci√≥n y Humanidades', 
            codigo: 'DAEH' 
          },
          // Programas Acad√©micos (los mantengo como departamentos seg√∫n tu estructura)
          { 
            nombre: 'Programa Acad√©mico de Derecho y Ciencias Pol√≠ticas', 
            codigo: 'PADCP' 
          },
          { 
            nombre: 'Programa Acad√©mico de Inicial y Especialidad', 
            codigo: 'PAIE' 
          },
          { 
            nombre: 'Programa Acad√©mico de Primaria e Inform√°tica', 
            codigo: 'PAPI' 
          },
          { 
            nombre: 'Programa Acad√©mico de Matem√°tica y Computaci√≥n', 
            codigo: 'PAMC' 
          },
          { 
            nombre: 'Programa Acad√©mico de Enfermer√≠a', 
            codigo: 'PAE' 
          }
        ]
      }
    },
    include: {
      departamentos: true
    }
  })

  console.log('‚úÖ Facultades y departamentos creados correctamente:')
  console.log(`  - ${facultadEcoturismo.nombre}: ${facultadEcoturismo.departamentos.length} departamentos`)
  console.log(`  - ${facultadIngenieria.nombre}: ${facultadIngenieria.departamentos.length} departamentos`)
  console.log(`  - ${facultadEducacion.nombre}: ${facultadEducacion.departamentos.length} departamentos/programas`)

  // Obtener todos los permisos creados
  const allPermissions = await prisma.permission.findMany()

  // Asignar permisos seg√∫n roles
  console.log('üîê Asignando permisos por rol...')

  // SUPER_ADMIN - Todos los permisos
  await prisma.userPermission.createMany({
    data: allPermissions.map(permission => ({
      userId: superAdmin.id,
      permissionId: permission.id,
      grantedBy: superAdmin.id,
      actions: [
        PermissionAction.CREATE,
        PermissionAction.READ,
        PermissionAction.UPDATE,
        PermissionAction.DELETE,
        PermissionAction.EXPORT
      ]
    }))
  })
  console.log('  ‚úì Super Admin: Todos los permisos')

  // ADMIN - Todos los permisos excepto administraci√≥n del sistema
  const adminPermissions = allPermissions.filter(p => p.code !== 'system.admin')
  await prisma.userPermission.createMany({
    data: adminPermissions.map(permission => ({
      userId: admin.id,
      permissionId: permission.id,
      grantedBy: superAdmin.id,
      actions: [
        PermissionAction.CREATE,
        PermissionAction.READ,
        PermissionAction.UPDATE,
        PermissionAction.DELETE,
        PermissionAction.EXPORT
      ]
    }))
  })
  console.log('  ‚úì Admin: Todos excepto system.admin')

  // MODERATOR - Solo gesti√≥n de contenido y dashboard
  const moderatorPermissions = allPermissions.filter(p => 
    p.code === 'dashboard.access' ||
    p.code === 'articles.access' ||
    p.code === 'categories.access'
  )
  await prisma.userPermission.createMany({
    data: moderatorPermissions.map(permission => ({
      userId: moderator.id,
      permissionId: permission.id,
      grantedBy: superAdmin.id,
      actions: permission.code === 'dashboard.access' 
        ? [PermissionAction.READ, PermissionAction.EXPORT]
        : [PermissionAction.CREATE, PermissionAction.READ, PermissionAction.UPDATE]
    }))
  })
  console.log('  ‚úì Moderator: Dashboard y contenido')

  // USER - Solo dashboard y configuraci√≥n personal
  const userPermissions = allPermissions.filter(p => 
    p.code === 'dashboard.access' ||
    p.code === 'settings.access'
  )
  await prisma.userPermission.createMany({
    data: userPermissions.map(permission => ({
      userId: user.id,
      permissionId: permission.id,
      grantedBy: superAdmin.id,
      actions: permission.code === 'settings.access'
        ? [PermissionAction.READ, PermissionAction.UPDATE]
        : [PermissionAction.READ]
    }))
  })
  console.log('  ‚úì User: Dashboard y configuraci√≥n personal')

  // Crear algunos logs de auditor√≠a de ejemplo
  await prisma.auditLog.createMany({
    data: [
      {
        userId: superAdmin.id,
        action: 'auth.login',
        entity: 'User',
        entityId: superAdmin.id,
        metadata: {
          ip: '127.0.0.1',
          userAgent: 'Mozilla/5.0'
        }
      },
      {
        userId: admin.id,
        action: 'auth.login',
        entity: 'User',
        entityId: admin.id,
        metadata: {
          ip: '127.0.0.1',
          userAgent: 'Mozilla/5.0'
        }
      }
    ]
  })

  console.log('‚úÖ Logs de auditor√≠a creados')

  // Resumen final
  console.log('\nüìä Resumen del seed:')
  console.log(`  - ${await prisma.user.count()} usuarios`)
  console.log(`  - ${await prisma.module.count()} m√≥dulos`)
  console.log(`  - ${await prisma.submodule.count()} subm√≥dulos`)
  console.log(`  - ${await prisma.permission.count()} permisos`)
  console.log(`  - ${await prisma.userPermission.count()} asignaciones de permisos`)
  console.log(`  - ${await prisma.facultad.count()} facultades`)
  console.log(`  - ${await prisma.departamento.count()} departamentos/programas`)

  console.log('\nüéâ Seed completado exitosamente!')
  console.log('\nüìù Usuarios de prueba:')
  console.log('  - superadmin@unamad.edu.pe / password123 (SUPER_ADMIN)')
  console.log('  - admin@unamad.edu.pe / password123 (ADMIN)')
  console.log('  - moderator@unamad.edu.pe / password123 (MODERATOR)')
  console.log('  - user@unamad.edu.pe / password123 (USER)')
}

main()
  .catch((e) => {
    console.error('‚ùå Error en seed:', e)
    process.exit(1)
  })
  .finally(async () => {
    await prisma.$disconnect()
  })